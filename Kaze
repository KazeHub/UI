-- WindowGenerator.lua
-- Single reusable function: CreateWindow(config)
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")

local function Create(class, props)
    local obj = Instance.new(class)
    if props then
        for k, v in pairs(props) do
            if k ~= "Parent" then
                obj[k] = v
            end
        end
        if props.Parent then
            obj.Parent = props.Parent
        end
    end
    return obj
end

local function makeDraggable(frame)
    local dragging, dragInput, dragStart, startPos

    local function update(input)
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(
            math.clamp(startPos.X.Scale, 0, 1),
            startPos.X.Offset + delta.X,
            math.clamp(startPos.Y.Scale, 0, 1),
            startPos.Y.Offset + delta.Y
        )
    end

    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            dragInput = input
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
end

local function CreateWindow(config)
    config = config or {}
    local titleText = tostring(config.Title or "Window")
    local authorText = tostring(config.Author or "")
    local versionText = tostring(config.Version or "")
    local theme = config.ThemeColor or Color3.fromRGB(0, 170, 255)

    local parent = Players.LocalPlayer and Players.LocalPlayer:FindFirstChild("PlayerGui") or game:GetService("CoreGui")

    local ScreenGui = Create("ScreenGui", {Parent = parent, Name = ("Hub_%s"):format(titleText:gsub("%s+", ""))})
    ScreenGui.ResetOnSpawn = false

    local Main = Create("Frame", {
        Parent = ScreenGui,
        Name = "Main",
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.new(0.5, 0, 0.48, 0),
        Size = UDim2.new(0, 720, 0, 420),
        BackgroundTransparency = 0.12,
        BackgroundColor3 = Color3.fromRGB(20, 20, 20),
    })

    Create("UICorner", {Parent = Main, CornerRadius = UDim.new(0, 14)})
    Create("UIStroke", {Parent = Main, Color = theme, Transparency = 0.25, Thickness = 2})
    Create("UIGradient", {
        Parent = Main,
        Color = ColorSequence.new{
            ColorSequenceKeypoint.new(0, Color3.fromRGB(30,30,30)),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(15,15,15))
        },
        Rotation = 90
    })

    -- Top bar
    local TopBar = Create("Frame", {
        Parent = Main,
        Name = "TopBar",
        Size = UDim2.new(1, 0, 0, 56),
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 0)
    })
    Create("UICorner", {Parent = TopBar, CornerRadius = UDim.new(0, 14)})

    local Title = Create("TextLabel", {
        Parent = TopBar,
        Name = "Title",
        Text = titleText,
        TextColor3 = Color3.fromRGB(240,240,240),
        TextScaled = true,
        BackgroundTransparency = 1,
        Size = UDim2.new(0.6, -12, 1, 0),
        Position = UDim2.new(0, 12, 0, 0),
        Font = Enum.Font.GothamBold,
        TextXAlignment = Enum.TextXAlignment.Left,
    })

    local Author = Create("TextLabel", {
        Parent = TopBar,
        Name = "Author",
        Text = (authorText ~= "" and ("by " .. authorText .. (versionText ~= "" and (" • " .. versionText) or ""))) or (versionText ~= "" and versionText or ""),
        TextColor3 = theme,
        TextScaled = false,
        BackgroundTransparency = 1,
        Size = UDim2.new(0.38, -12, 1, 0),
        Position = UDim2.new(0.6, 12, 0, 0),
        Font = Enum.Font.Gotham,
        TextXAlignment = Enum.TextXAlignment.Right,
    })

    -- Close button
    local CloseBtn = Create("TextButton", {
        Parent = TopBar,
        Name = "Close",
        Text = "✕",
        TextColor3 = theme,
        BackgroundTransparency = 0.15,
        BackgroundColor3 = Color3.fromRGB(0,0,0),
        Size = UDim2.new(0, 36, 0, 36),
        Position = UDim2.new(1, -48, 0, 10),
        AutoButtonColor = false,
        Font = Enum.Font.GothamBold,
        TextScaled = true,
    })
    Create("UICorner", {Parent = CloseBtn, CornerRadius = UDim.new(0, 8)})
    Create("UIStroke", {Parent = CloseBtn, Color = theme, Transparency = 0.2, Thickness = 1})

    -- Content holder
    local Content = Create("Frame", {
        Parent = Main,
        Name = "Content",
        Position = UDim2.new(0, 16, 0, 72),
        Size = UDim2.new(1, -32, 1, -88),
        BackgroundTransparency = 1,
    })

    -- Sample left strip (for tabs later)
    local LeftStrip = Create("Frame", {
        Parent = Content,
        Name = "LeftStrip",
        Size = UDim2.new(0, 88, 1, 0),
        Position = UDim2.new(0, 0, 0, 0),
        BackgroundTransparency = 0.4,
        BackgroundColor3 = Color3.fromRGB(10,10,10)
    })
    Create("UICorner", {Parent = LeftStrip, CornerRadius = UDim.new(0, 10)})
    Create("UIStroke", {Parent = LeftStrip, Color = theme, Thickness = 1, Transparency = 0.55})

    local RightContent = Create("Frame", {
        Parent = Content,
        Name = "RightContent",
        Position = UDim2.new(0, 104, 0, 0),
        Size = UDim2.new(1, -104, 1, 0),
        BackgroundTransparency = 1
    })

    -- Floating return button
    local ReturnBtn = Create("TextButton", {
        Parent = ScreenGui,
        Name = "Return",
        Text = "↺",
        TextColor3 = theme,
        BackgroundColor3 = Color3.fromRGB(20,20,20),
        BackgroundTransparency = 0.08,
        Size = UDim2.new(0, 44, 0, 44),
        Position = UDim2.new(0, 16, 1, -76),
        AnchorPoint = Vector2.new(0, 0),
        Visible = false,
        AutoButtonColor = false,
        Font = Enum.Font.GothamBold,
        TextScaled = true,
    })
    Create("UICorner", {Parent = ReturnBtn, CornerRadius = UDim.new(0, 12)})
    Create("UIStroke", {Parent = ReturnBtn, Color = theme, Transparency = 0.2, Thickness = 1})

    -- Behavior
    CloseBtn.MouseButton1Click:Connect(function()
        Main.Visible = false
        ReturnBtn.Visible = true
    end)

    ReturnBtn.MouseButton1Click:Connect(function()
        Main.Visible = true
        ReturnBtn.Visible = false
    end)

    -- Make draggable (topbar + main)
    makeDraggable(TopBar)
    makeDraggable(ReturnBtn)

    -- Responsive adjustments for mobile
    if UserInputService.TouchEnabled and not UserInputService.MouseEnabled then
        Main.Size = UDim2.new(0.92, 0, 0.88, 0)
        Main.Position = UDim2.new(0.5, 0, 0.5, 0)
    end

    -- Utility API
    local api = {}

    api.ScreenGui = ScreenGui
    api.Main = Main
    api.Content = RightContent

    function api.SetTitle(newTitle)
        Title.Text = tostring(newTitle or "")
    end

    function api.SetAuthor(newAuthor, newVersion)
        authorText = tostring(newAuthor or "")
        versionText = tostring(newVersion or versionText or "")
        Author.Text = (authorText ~= "" and ("by " .. authorText .. (versionText ~= "" and (" • " .. versionText) or ""))) or (versionText ~= "" and versionText or "")
    end

    function api.Destroy()
        ScreenGui:Destroy()
    end

    -- Return the API table
    return api
end

return CreateWindow
